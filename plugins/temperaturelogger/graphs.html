<html>
<head>
<title>Graphs!</title>
<script type="text/javascript"
	src="http://dygraphs.com/dygraph-combined.js"></script>

<style type="text/css">
.chart {
	width: 1000px;
	height: 600px;
	border-left: 4px solid #ccc;
	margin-top: 4ex;
}
p {
	max-width: 100ex;
}
</style>

</head>

<body>
	<p>Temperature (and battery/supply voltage) data from two <a href="http://en.wikipedia.org/wiki/XBee">XBee</a>s in my apartment. Temperature from three <a href="http://learn.adafruit.com/tmp36-temperature-sensor">TEMP36 sensors</a> which claim &plusmn;1&deg;C accuracy typical (which maps to 1&frac12;&deg;F).</p>
	<p>Mouse over to see values; hover over annotations for details. Drag to zoom, double-click to zoom back out. Rendered by <a href="http://dygraphs.com/">Dygraphs</a>. (By default, graphs are zoomed to the last 24 hours.)</p>

	<p>See also: <a href="http://weatherspark.com/#!dashboard;q=Cambridge%2C%20MA%2C%20USA">weather graphs for Cambridge, MA</a>.</p>

	<div id="temperatureGraph" class="chart"></div>
	<div id="voltageGraph" class="chart"></div>
</body>

<script type="text/javascript">
var DEFAULT_WINDOW_MILLIS = 1 * 24 * 60 * 60 * 1000;
var NOW = new Date().valueOf();
var HTTP_OK = 200;
var HTTP_CHROME_LOCAL_OK = 0;
var XHR_STATE_READY = 4;

var graphs = [];
var blockRedraw = false;
// see http://dygraphs.com/tests/synchronize.html
function synchronizeZooms(drawnGraph, firstDraw) {
	if (blockRedraw || firstDraw) {
		return;
	}
	blockRedraw = true;
	var xRange = drawnGraph.xAxisRange();
	for (var i = 0; i < graphs.length; i++) {
		if (graphs[i] == drawnGraph) {
			continue;
		}
		graphs[i].updateOptions({dateWindow: xRange});
	}
	blockRedraw = false;
}

function drawGraph(elementId, graphData, titleHtml, annotations) {
	var g = new Dygraph(
		document.getElementById(elementId),
		graphData,
		{
			title: titleHtml,
			connectSeparatedPoints: true,
			drawGapEdgePoints: true,
			dateWindow:
				[NOW - DEFAULT_WINDOW_MILLIS, NOW],
			drawCallback: synchronizeZooms,
		});
	if (annotations) {
		g.setAnnotations(annotations);
	}
	graphs.push(g);
}

function fetchAndDrawGraph(eid, fileName, title, ann) {
	var req = new XMLHttpRequest();
	req.onreadystatechange = function() {
		if (req.readyState == XHR_STATE_READY &&
				(req.status == HTTP_OK ||
				req.status == HTTP_CHROME_LOCAL_OK)) {
			drawGraph(eid, req.responseText, title, ann);
		}
	};
	req.open('GET', fileName, true);
	req.send(null);
}

var temperatureAnnotations = [
	{	series: 'Bathroom a',
		x: '2012/08/27 22:54:44 UTC',
		shortText: 'X',
		text: 'no reverse-voltage protection (sensor fried)',
	},
	{	series: 'Bedroom',
		x: '2012/08/28 04:20:51 UTC',
		shortText: 'AC',
		text: 'turn on air conditioning (central air)',
	},
	{	series: 'Outdoor',
		x: '2012/08/28 14:26:02 UTC',
		shortText: 'Rn',
		text: 'rain ends mid-morning',
	},
	{	series: 'Bedroom',
		x: '2012/09/03 15:53:04 UTC',
		shortText: 'Gn',
		text: 'gone with computer for the day',
	},
	{	series: 'Bedroom',
		x: '2012/09/05 06:42:18 UTC',
		shortText: 'Sl',
		text: 'computer went to sleep',
	},
	{	series: 'Outdoor',
		x: '2012/09/05 17:01:09 UTC',
		shortText: '?',
		text: 'intermittent rejoining / not sending IO samples',
	},
	{	series: 'Bedroom',
		x: '2012/09/06 01:36:24 UTC',
		shortText: 'SN',
		text: 'shortened number of sleep periods from 10 to 5',
	},
	{	series: 'Bathroom b',
		x: '2012/09/09 00:44:28 UTC',
		shortText: 'X',
		text: 'bogus -58F recorded for bathroom/outdoor: removed',
	},
	{	series: 'Bedroom',
		x: '2012/09/12 03:01:42 UTC',
		shortText: 'S',
		text: 'moved coordinator XBee to server machine',
	},
	{	series: 'Bathroom b',
		x: '2012/09/12 03:34:44 UTC',
		shortText: 'B',
		text: 'new board for bathroom/outdoor XBee: seats properly',
	},
	{	series: 'Bathroom b',
		x: '2012/09/13 03:32:39 UTC',
		shortText: 'Lr',
		text: 'move outdoor/bathroom XBee to living room:'
			+ ' closer to coordinator XBee',
	},
	{	series: 'Bathroom b',
		x: '2012/09/13 17:37:15 UTC',
		shortText: 'Su',
		text: 'guess: sun through the window on the sensor',
	},
	{
		series: 'Bedroom',
		x: '2012/09/14 00:00:01 UTC',
		shortText: 'F',
		text: 'start evacuative window fan in LR with BR window open',
	},
	{
		series: 'Bedroom',
		x: '2012/09/14 02:45:20 UTC',
		shortText: 'F',
		text: 'evacuative window fan on',
	},
];

var voltageAnnotations = [
	{	series: 'Bedroom',
		x: '2012/08/28 01:01:34 UTC',
		shortText: '3v',
		text: '3.3v regulated from FTDI USB adapter'
			+ ' attached to A/C adapter',
	},
	{	series: 'Bathroom',
		x: '2012/08/29 10:51:44 UTC',
		shortText: 'Ni',
		text: 'fresh 3xNiMH charge, no sleeping',
	},
	{	series: 'Bathroom',
		x: '2012/08/31 12:08:14 UTC',
		shortText: 'LP',
		text: 'fresh LiPo charge, no sleeping',
	},
	{	series: 'Bathroom',
		x: '2012/09/03 02:36:12 UTC',
		shortText: 'LP',
		text: 'fresh LiPo charge, with 28s sleep cycle'
			+ ' and 5 minute sampling cycle',
	},
	{	series: 'Bedroom',
		x: '2012/09/03 13:35:09 UTC',
		shortText: 'Ni',
		text: 'fresh 3xNiMH charge, with 28s sleep cycle'
			+ ' and 5 minute sampling cycle',
	},
];

fetchAndDrawGraph('temperatureGraph',
	'combined-temperature.csv',
	'Temperature (&deg;F)',
	temperatureAnnotations);
fetchAndDrawGraph('voltageGraph',
	'combined-voltage.csv',
	'Voltage',
	voltageAnnotations);
</script>

</html>
